# docker-compose.coolify.yml
# For Coolify deployment - connects to external PostgreSQL and Qdrant

services:
  # Python API (public at cems.chocksy.com)
  cems-server:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      CEMS_DATABASE_URL: ${CEMS_DATABASE_URL}
      CEMS_QDRANT_URL: ${CEMS_QDRANT_URL}
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY}
      CEMS_ADMIN_KEY: ${CEMS_ADMIN_KEY}
      CEMS_MODE: server
      CEMS_SERVER_HOST: 0.0.0.0
      CEMS_SERVER_PORT: 8765
      CEMS_MCP_PUBLIC_URL: https://mcp-cems.chocksy.com/mcp
    # Memory limit prevents OOM cascade that kills other services on the host.
    # Idle: ~115 MB RSS. Search joins chunks with doc metadata (not full content).
    mem_limit: 768m
    memswap_limit: 768m
    expose:
      - "8765"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.cems-server.rule=Host(`cems.chocksy.com`)"
      - "traefik.http.routers.cems-server.entryPoints=https"
      - "traefik.http.routers.cems-server.tls=true"
      - "traefik.http.routers.cems-server.tls.certresolver=letsencrypt"
      - "traefik.http.services.cems-server.loadbalancer.server.port=8765"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8765/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - coolify

  # Express MCP wrapper (public at mcp-cems.chocksy.com)
  cems-mcp:
    build:
      context: ./mcp-wrapper
      dockerfile: Dockerfile
    environment:
      PYTHON_API_URL: http://cems-server:8765
      PORT: 8766
    expose:
      - "8766"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.cems-mcp.rule=Host(`mcp-cems.chocksy.com`)"
      - "traefik.http.routers.cems-mcp.entryPoints=https"
      - "traefik.http.routers.cems-mcp.tls=true"
      - "traefik.http.routers.cems-mcp.tls.certresolver=letsencrypt"
      - "traefik.http.services.cems-mcp.loadbalancer.server.port=8766"
    depends_on:
      cems-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8766/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - coolify

networks:
  coolify:
    external: true
